(function(){"use strict";angular.module("webappProtoApp",["config","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ui.router","ngStorage","ngTouch","ngCordova","offline"]).config(["$stateProvider","$urlRouterProvider","$resourceProvider","$httpProvider",function(a,b,c,d){return c.defaults.stripTrailingSlashes=!1,d.defaults.xsrfCookieName="csrftoken",d.defaults.xsrfHeaderName="X-CSRFToken",b.otherwise("/user/main"),a.state("test",{url:"/test",templateUrl:"views/test.html",controller:"TestCtrl"}).state("user",{url:"/user",templateUrl:"views/base.html",controller:"UserCtrl",resolve:{currentUser:["userSrv",function(a){return a.getLogged()}]}}).state("user.main",{url:"/main",templateUrl:"views/main.html",controller:"MainCtrl"}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"})}]).run(["$rootScope","connectionStatus",function(a,b){return a.$on("$stateChangeError",function(a,b,c,d,e,f){return console.log(f)}),a.isOnline=b.isOnline(),b.$on("online",function(){return console.log("Go Online"),a.isOnline=!0}),b.$on("offline",function(){return console.log("Go offline"),a.isOnline=!1})}]).run(["PushNotifSvc","syncMessage","NotifSvc",function(a,b,c){return a.reSetHandler(),console.log("launching RUN"),a.register("msg",function(a){return console.log("bla  ",a),b.fetch().then(function(){var a,d,e;return d=b.getData(),a=d[0].content,console.log("rcv message : ",a),e={TAG:"msg",icon:"https://taiga.mhcomm.fr/images/favicon.png",body:'message : "'+a+'"',dir:"rtl"},c.addNotif("new msg receive",e)})})}]).run(["NotifSvc",function(a){var b;return console.log("run of notif"),b=a.addNotif("test",{body:"I am here to be sure that notifications works",dir:"auto",icon:"https://taiga.mhcomm.fr/images/favicon.png",TAG:"NOTIF"})}])}).call(this),angular.module("config",[]).constant("CONF",{server:"http://192.168.42.21:9000"}),function(){"use strict";angular.module("webappProtoApp").controller("TestCtrl",["cordova","$cordovaDevice","$cordovaDialogs","$cordovaLocalNotification",function(a,b,c,d){return console.log("test"),a.ready.then(function(){var a;return console.log("Cordova loaded"),a=b.getDevice(),console.log(a.model),console.log(a.cordova),console.log(a.platform),console.log(a.uuid),console.log(a.version),c.alert("The super message","A title","Okayyyyy").then(function(){return console.log("donnnnnnne")}),d.schedule({id:1,title:"Super notif",text:"Webapp proto is actually working",data:{customProperty:"custom value"}}).then(function(){return console.log("Dooooone tooo")})})}])}.call(this),function(){"use strict";angular.module("webappProtoApp").controller("MainCtrl",["$scope","syncMessage","$state","$localStorage","utils","$location","cordova",function(a,b,c,d,e,f,g){return g.ready.then(function(){return console.log("Cordova loaded")}),a.messages=[],a.install=function(){var a,b;return a=f.protocol()+"://"+f.host()+":"+f.port()+"/manifest.webapp",console.log(a),b=navigator.mozApps.install(a),console.log("ok"),b.onsuccess=function(){return console.log("Youhou"),console.log(this.result.origin)},b.onerror=function(){return console.log("Hoooooo"),console.log(this.error.name)}},a.msgSrv=b,a["new"]=b["new"]({author:a.user.id,content:"",uid:e.genUUID()}),a.save=function(){return a["new"].$save().then(function(){return a["new"]=b["new"]({author:a.user.id,content:"",uid:e.genUUID()})})}}])}.call(this),function(){angular.module("webappProtoApp").controller("LoginCtrl",["$scope","userSrv","$state",function(a,b,c){return a.credentials={},a.loginFailed=!1,a.login=function(){var d,e,f,g;return g=a.credentials,f=g.username,e=g.password,d=b.login(f,e),d?c.go("user.main",{userId:d.id}):a.loginFailed=!0}}])}.call(this),function(){"use strict";angular.module("webappProtoApp").controller("UserCtrl",["$scope","userSrv","$state","currentUser",function(a,b,c,d){return d||b.gotoLogin(),a.user=d,a.disconnect=function(){return b.logout()}}])}.call(this),function(){"use strict";var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};angular.module("webappProtoApp").factory("messageLocal",["$localStorage",function(a){var b;return b=[],null==a.messages?a.messages=[]:b=a.messages,{newMessage:function(b,c){var d;return d={timestamp:new Date,author:c.id,content:b},a.messages.push(d)}}}]).factory("messageSrv",["$resource","CONF",function(a,b){var c;return c=a(b.server+"/api/messages/:_id/")}]).factory("restMessage",["$resource","CONF",function(a,b){var c;return c=a(b.server+"/api/messages/:_id/"),{query:c.query,get:c.get,save:c.save,"new":function(a){return new c(a)}}}]).factory("syncMessage",["$resource","$q","$localStorage","restMessage","connectionStatus","$timeout","$rootScope","NotifSvc",function(b,c,d,e,f,g){var h,i,j,k,l,m;return l="messages",k="_tx"+l,i="_fetched"+l,null==d[i]&&(d[i]=!1),null==d[k]&&(d[k]=[]),null==d[l]&&(d[l]=[]),h=function(){function a(a){console.log("Create new message"),this.timestamp=new Date,angular.extend(this,a)}return a.prototype.$save=function(){return m.save(this)},a}(),m={isOnline:f.isOnline(),sync:function(){var b,c,f,g,h,i;if(d[k]){for(console.log("Tx: "+d[k].length+" elem(s) to sync."),g=d[l],i=[],c=0,f=g.length;f>c;c++)b=g[c],h=b.uid,i.push(a.call(d[k],h)>=0?e["new"](b).$save().then(function(a){return b.needSync=!1,d[k].splice(d[k].indexOf(a.uid),1)},function(a){return console.log("error: ",a)}):void 0);return i}},fetch:function(){return e.query().$promise.then(function(a){var b,c;return c=function(){var a,c,e,f;for(e=d[l],f=[],a=0,c=e.length;c>a;a++)b=e[a],f.push(b.uid);return f}(),d[l]=a,d[l].sort(function(a,b){var c,d,e,f;return c=new Date(a.timestamp),d=new Date(b.timestamp),null!=(e=c>d)?e:{1:null!=(f=d>c)?f:-{1:0}}}),d[l].reverse()})},query:function(){var a;return console.log("Query message list"),a=c.defer(),d[i]||(d[i]=!0,m.fetch()),a.resolve(d[l]),{$promise:a.promise}},save:function(a){var b;return console.log("Save message"),b=c.defer(),a.needSync=!0,d[l].push(a),d[l].sort(function(a,b){var c,d,e,f;return c=new Date(a.timestamp),d=new Date(b.timestamp),null!=(e=c>d)?e:{1:null!=(f=d>c)?f:-{1:0}}}),d[l].reverse(),console.log(d[l]),d[k].push(a.uid),this.isOnline&&this.sync(),b.resolve(a),b.promise},get:function(){return null},"new":function(a){return new h(a)},getData:function(){return d[l]}},f.$on("online",function(){return m.isOnline=!0,m.sync()}),f.$on("offline",function(){return m.isOnline=!1}),j=function(){return m.isOnline&&(console.log("Sync message resource"),m.sync()),g(j,5e3)},j(),m}])}.call(this),function(){"use strict";angular.module("webappProtoApp").factory("userSrv",["$localStorage","$http","$log","$q","$window","CONF",function(a,b,c,d,e,f){return{getLogged:function(){var a;return a=d.defer(),b.get(f.server+"/dj/get_user").success(function(b){return c.debug("Connected"),a.resolve(b)}).error(function(){return c.debug("Not connected"),a.resolve()}),a.promise},gotoLogin:function(){return e.location.href=f.server+"/api-auth/login/?next=/"},logout:function(){return e.location.href=f.server+"/api-auth/logout/?next="+f.server+"/api-auth/login/"}}}])}.call(this),function(){"use strict";angular.module("webappProtoApp").factory("utils",function(){return{genUUID:function(){var a,b;return a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c;return c=(a+16*Math.random())%16|0,a=Math.floor(a/16),("x"===b?c:3&c|8).toString(16)})}}})}.call(this),function(){angular.module("webappProtoApp").factory("PushNotifSvc",["$localStorage","$window","$q","$http","clientSvc","NotifSvc",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o;return g={},f=e.getUID(),j=b.navigator.mozSetMessageHandler&&b.navigator.push,k=function(){return b.navigator.mozSetMessageHandler("push",h),b.navigator.mozSetMessageHandler("push-register",function(){var b,c,d,e,f;console.log("in callback of re-push"),console.log("push-register received, I need to register my endpoint(s) again!"),d=g,g={},e=a.endPointsByName,a.endPointsByUrl={},a.endPointsByName={},f=[];for(b in e)c=e[b],f.push(registerPushNotification(c,d[c]));return f})},j?(console.log("initializing service PushNotifSvc"),a.endPointsByUrl||(a.endPointsByUrl={}),a.endPointsByName||(a.endPointsByName={})):console.log("your web browser is not compatible with push notifications"),l=function(b,d){var e,f;return console.log("start register"),e=c.defer(),g[b]||(g[b]=c.defer()),a.endPointsByName[b]?(g[b].resolve(d),e.resolve(a.endPointsByName[b].url),m(b,a.endPointsByName[b].url)):(f=navigator.push.register(),f.onsuccess=function(){var c;return c=f.result,a.endPointsByName[b]={url:c},a.endPointsByUrl[c]={name:b},g[b].resolve(d),console.log("registering endoint "+b+" with url "+c),m(b,c),e.resolve(c)},f.onerror=function(a){return console.error("Error getting a new endpoint: "+JSON.stringify(a)),e.reject(),g[b].reject()}),e.promise},n=function(b){var d,e,f;return d=c.defer(),e=a.endPointsByName[b].url,e?(console.log("trying to untregister endpoint "+b),console.debug("with url "+e),f=navigator.push.unregister(e),f.onsuccess=function(){var c;return c=f.result,c!==e&&console.log("both endpoint are not equals"),a.endPointsByUrl[e]=void 0,a.endPointsByName[b]=void 0,g[name]=void 0,console.log("endpoint "+b+" unregistered"),o(b),d.resolve()},f.onerror=function(a){return console.error("Error unregistering the endpoint: "+JSON.stringify(a)),console.error(a),d.reject()}):(console.error("cannot retrieve endpoint in localStorage"),d.resolve(),o(b)),d.promise},h=function(b){var d,e,f;return console.log("in cb receive push notif"),e=b.pushEndpoint,f=b.version,d=a.endPointsByUrl[e].name,console.log("in push notif callback for "+d+" with version="+f),g[d]||(g[d]=c.defer()),g[d].promise.then(function(a){return a(f)})},m=function(a,b){var c;return c="/api/client/register/",d.post(c,{uid:f,topic_name:a,endpoint_url:b})},o=function(a){var b;return b="/api/client/unregister/",d.post(b,{uid:f,topic_name:a})},i=function(){return g={},a.endPointsByUrl={},a.endPointsByName={},console.log("internal structure of push niotification is now cleared")},j?{register:l,cleanAllStorage:i,unregister:n,reSetHandler:k}:{cleanAllStorage:function(){return console.log("your web browser is not compatible with push notifications")},register:function(){return console.log("your web browser is not compatible with push notifications")},unregister:function(){return console.log("your web browser is not compatible with push notifications")},reSetHandler:function(){return console.log("your web browser is not compatible with push notifications")}}}])}.call(this),function(){angular.module("webappProtoApp").factory("NotifSvc",["$window","$timeout",function(a,b){var c,d,e,f,g;return"undefined"==typeof Notification||null===Notification?(console.log("No desktop notification on this platform !"),{addNotif:function(a,b){return console.log("Should notify "+a+": "+b)}}):("granted"!==Notification.permission&&Notification.requestPermission(function(a){return Notification.permission=a}),f=function(){return console.log("error on notif")},g=function(){return console.log("showing notif")},d=function(){return console.log("click on notif")},e=function(){return console.log("closing notif")},c=function(a,c){var h;return console.log("permision : ",Notification.permission),h=new Notification(a,c),h.onerror=f,h.onclick=d,h.onshow=g,h.onclose=e,b(function(){return h.close()},5e3),h},{addNotif:c})}])}.call(this),function(){"use strict";angular.module("webappProtoApp").factory("clientSvc",["$localStorage","$log","utils",function(a,b,c){var d;return d=function(){return a.clientUID||(a.clientUID=c.genUUID()),console.log("uid of client : "+a.clientUID),a.clientUID},{getUID:d}}])}.call(this),function(){"use strict";angular.module("webappProtoApp").factory("cordova",["$q","$window","$timeout",function(a,b,c){var d,e;return d=a.defer(),e=!1,document.addEventListener("deviceready",function(){return e=!0,d.resolve(b.cordova)}),c(function(){return!e&&b.cordova?d.resolve(b.cordova):void 0},3e3),{ready:d.promise}}])}.call(this);